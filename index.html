<!doctype html>
<html lang="my">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Idle Farm</title>

  <!-- âœ… Telegram WebApp SDK (needed for user.id binding) -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root { --bg:#0b0c10; --card:#141621; --muted:#98a2b3; --txt:#eef2ff; --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; background:linear-gradient(180deg,#07070a, #0b0c10); color:var(--txt);}
    header{position:sticky;top:0;z-index:5;background:rgba(10,11,16,.85);backdrop-filter:blur(10px);border-bottom:1px solid rgba(255,255,255,.06)}
    .top{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;gap:12px}
    .brand{display:flex;flex-direction:column;gap:2px}
    .brand b{font-size:16px}
    .brand small{color:var(--muted);font-size:12px}
    .pill{display:flex;gap:10px;align-items:center;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);padding:8px 10px;border-radius:999px;font-size:13px;white-space:nowrap}
    .pill span{color:var(--muted)}
    .nav{display:flex;gap:8px;padding:0 16px 12px}
    .tab{flex:1;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.04);color:var(--txt);padding:10px;border-radius:12px;font-size:13px}
    .tab.active{background:rgba(34,197,94,.15);border-color:rgba(34,197,94,.35)}
    main{padding:16px;max-width:860px;margin:0 auto}

    .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    @media (min-width:720px){ .grid{grid-template-columns:repeat(4,minmax(0,1fr));} }

    .plot{background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:12px;min-height:130px;display:flex;flex-direction:column;gap:10px}
    .plot h3{margin:0;font-size:14px}
    .meta{display:flex;justify-content:space-between;gap:10px;color:var(--muted);font-size:12px}
    .state{font-size:12px;color:var(--muted)}
    .btnrow{display:flex;gap:8px;margin-top:auto}
    button{border:0;border-radius:12px;padding:10px 10px;font-weight:700;font-size:13px}
    .primary{background:rgba(34,197,94,.95);color:#07110a}
    .ghost{background:rgba(255,255,255,.06);color:var(--txt);border:1px solid rgba(255,255,255,.08)}
    .danger{background:rgba(239,68,68,.92);color:#130709}
    .mutedBtn{background:rgba(255,255,255,.03);color:rgba(255,255,255,.55);border:1px solid rgba(255,255,255,.08)}
    .shop{display:grid;grid-template-columns:1fr;gap:12px}
    @media (min-width:720px){ .shop{grid-template-columns:repeat(2,minmax(0,1fr));} }
    .card{background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:14px;display:flex;flex-direction:column;gap:10px}
    .row{display:flex;justify-content:space-between;gap:12px;align-items:flex-start}
    .name{font-weight:900}
    .desc{color:var(--muted);font-size:12px;line-height:1.45}
    .price{font-weight:900}
    .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:rgba(0,0,0,.85);border:1px solid rgba(255,255,255,.12);padding:10px 12px;border-radius:12px;font-size:13px;opacity:0;pointer-events:none;transition:opacity .2s}
    .toast.show{opacity:1}
    .hint{color:var(--muted);font-size:12px;margin-top:10px}
    .small{font-size:12px;color:var(--muted)}
    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas; font-size:11px; padding:2px 6px; border:1px solid rgba(255,255,255,.12); border-radius:8px; background:rgba(255,255,255,.04)}

    /* ===== Modal Crop Picker ===== */
    .modalBack{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:flex-end;justify-content:center;z-index:50}
    .modal{width:min(900px,100%);background:rgba(20,22,33,.98);border-top:1px solid rgba(255,255,255,.10);
      border-left:1px solid rgba(255,255,255,.06);border-right:1px solid rgba(255,255,255,.06);
      border-radius:18px 18px 0 0;padding:14px 14px 18px;max-height:80vh;overflow:auto}
    .modalHeader{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:10px}
    .modalHeader b{font-size:14px}
    .modalHeader small{color:var(--muted)}
    .closeX{width:40px;height:40px;border-radius:12px}
    .cropGrid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    @media (min-width:720px){ .cropGrid{grid-template-columns:repeat(3,minmax(0,1fr));} }
    .cropCard{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:12px;display:flex;flex-direction:column;gap:8px}
    .cropTop{display:flex;justify-content:space-between;align-items:center}
    .cropIcon{font-size:22px}
    .badge{font-size:11px;padding:3px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.12);color:var(--muted)}
    .badge.ok{color:rgba(34,197,94,.95);border-color:rgba(34,197,94,.35);background:rgba(34,197,94,.08)}
    .badge.bad{color:rgba(239,68,68,.95);border-color:rgba(239,68,68,.35);background:rgba(239,68,68,.08)}
    .cropCard .name{font-size:14px}
    .cropMeta{display:flex;justify-content:space-between;gap:10px;color:var(--muted);font-size:12px}
    .cropActions{display:flex;gap:8px;margin-top:6px}
    .fullBtn{flex:1}
  </style>
</head>
<body>
<header>
  <div class="top">
    <div class="brand">
      <b>ğŸŒ¾ Idle Farm</b>
      <small>Buy Seeds â†’ Plant â†’ Wait â†’ Harvest</small>
    </div>
    <div class="pill">
      <div>ğŸ’° <b id="coins">0</b> <span>coins</span></div>
      <div>â­ <b id="level">1</b> <span>lvl</span></div>
    </div>
  </div>
  <div class="nav">
    <button class="tab active" id="tabFarm">Farm</button>
    <button class="tab" id="tabShop">Shop</button>
    <button class="tab" id="tabProfile">Profile</button>
  </div>
</header>

<main>
  <section id="viewFarm">
    <div class="grid" id="plots"></div>
    <div class="hint">Tip: Seed á€™á€›á€¾á€­á€›á€„á€º Plant á€™á€œá€¯á€•á€ºá€”á€­á€¯á€„á€ºá€•á€«á‹ Shop á€™á€¾á€¬ á€á€šá€ºá€•á€¼á€®á€¸á€™á€¾ Plant á€œá€¯á€•á€ºá€•á€«á‹</div>
  </section>

  <section id="viewShop" style="display:none;">
    <div class="card">
      <div class="row">
        <div>
          <div class="name">ğŸ§± Plot Upgrade</div>
          <div class="desc">á€™á€¼á€±á€€á€½á€€á€ºá€¡á€á€…á€º 1 á€€á€½á€€á€º á€‘á€•á€ºá€–á€½á€„á€·á€ºá€™á€šá€º (max 8 plots)</div>
        </div>
        <div style="text-align:right">
          <div class="price"><span id="plotCost">200</span> coins</div>
          <button class="primary" id="buyPlotBtn">Buy Plot</button>
        </div>
      </div>
      <div class="small">Plot á€á€­á€¯á€¸á€›á€„á€º Farm á€™á€¾á€¬ grid á€‘á€²á€€á€½á€€á€ºá€¡á€á€…á€ºá€•á€±á€«á€ºá€œá€¬á€™á€šá€ºá‹</div>
    </div>

    <div class="shop" id="shopList"></div>
    <div class="hint">Seed á€á€šá€ºá€•á€¼á€®á€¸ Inventory á€‘á€²á€›á€¾á€­á€á€²á€·á€¡á€›á€±á€¡á€á€½á€€á€ºá€”á€²á€· Plant á€œá€¯á€•á€ºá€”á€­á€¯á€„á€ºá€•á€«á€á€šá€ºá‹</div>
  </section>

  <section id="viewProfile" style="display:none;">
    <div class="card">
      <div class="row">
        <div>
          <div class="name">ğŸ‘¤ Profile</div>
          <div class="desc">Telegram account á€á€…á€ºá€á€¯á€á€»á€„á€ºá€¸ Save á€á€®á€¸á€á€”á€·á€ºá€–á€¼á€…á€ºá€¡á€±á€¬á€„á€º binding á€œá€¯á€•á€ºá€‘á€¬á€¸á€á€šá€ºá‹</div>
          <div class="small" id="tgInfo" style="margin-top:6px;"></div>
        </div>
      </div>
      <div class="row">
        <div>Total Harvests</div><b id="harvests">0</b>
      </div>
      <div class="row">
        <div>Total Earned</div><b id="earned">0</b>
      </div>
      <div class="row">
        <div>Plots</div><b id="plotCount">2</b>
      </div>
      <div class="row">
        <div>Seeds (Total)</div><b id="seedTotal">0</b>
      </div>
      <div class="btnrow">
        <button class="ghost" id="exportBtn">Export Save</button>
        <button class="ghost" id="importBtn">Import Save</button>
        <button class="danger" id="resetBtn">Reset</button>
      </div>
      <div class="hint">Export/Import á€€á€­á€¯ <span class="kbd">copy/paste</span> á€”á€²á€· save á€•á€¼á€±á€¬á€„á€ºá€¸á€œá€­á€¯á€·á€›á€á€šá€ºá‹</div>
    </div>
  </section>
</main>

<!-- Modal: Crop picker -->
<div class="modalBack" id="modalBack">
  <div class="modal" role="dialog" aria-modal="true">
    <div class="modalHeader">
      <div>
        <b id="modalTitle">Choose a crop</b><br>
        <small id="modalSub">Pick crop to plant</small>
      </div>
      <button class="ghost closeX" id="modalClose">âœ•</button>
    </div>
    <div class="cropGrid" id="cropGrid"></div>
    <div class="hint" style="margin-top:12px">
      âœ… Seed á€›á€¾á€­á€›á€„á€º Plant á€œá€¯á€•á€ºá€œá€­á€¯á€·á€›á€™á€šá€ºá‹ âŒ Seed á€™á€›á€¾á€­á€›á€„á€º Shop á€™á€¾á€¬ á€á€šá€ºá€•á€«á‹
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
/** ========== Idle Farm (Shop Seeds -> Inventory -> Plant) ========== **/

/* ===== âœ… Telegram Binding ===== */
const tg = window.Telegram?.WebApp;
try { tg?.ready(); } catch(e) {}

const tgUser = tg?.initDataUnsafe?.user || null;
const TG_USER_ID = tgUser?.id || null;

// âœ… per-account storage key
const STORAGE_KEY = TG_USER_ID ? `idle_farm_save_v2_${TG_USER_ID}` : `idle_farm_save_v2_guest`;

// old keys (for migrate)
const OLD_V2_KEY = "idle_farm_save_v2"; // previous non-telegram binding
const OLD_V1_KEY = "idle_farm_save_v1";

const MAX_PLOTS = 8;

const CROPS = [
  { id:"lettuce", icon:"ğŸ¥¬", name:"Lettuce",  growSec: 60*2,  seedPrice: 5,   reward: 10,  xp: 3  },
  { id:"corn",    icon:"ğŸŒ½", name:"Corn",     growSec: 60*10, seedPrice: 25,  reward: 60,  xp: 10 },
  { id:"tomato",  icon:"ğŸ…", name:"Tomato",   growSec: 60*60, seedPrice: 150, reward: 400, xp: 40 }
];

const $ = (id)=>document.getElementById(id);
const toastEl = $("toast");

function toast(msg){
  toastEl.textContent = msg;
  toastEl.classList.add("show");
  setTimeout(()=>toastEl.classList.remove("show"), 1700);
}

function now(){ return Date.now(); }
function fmtTime(sec){
  sec = Math.max(0, Math.floor(sec));
  const h = Math.floor(sec/3600);
  const m = Math.floor((sec%3600)/60);
  const s = sec%60;
  if(h>0) return `${h}h ${m}m`;
  if(m>0) return `${m}m ${s}s`;
  return `${s}s`;
}

function plotUpgradeCost(plotCount){
  const n = plotCount - 2;
  return Math.floor(200 + (n*n)*120 + n*180);
}

function seedTotal(inv){
  return Object.values(inv||{}).reduce((a,b)=>a+(b||0),0);
}

function defaultSave(){
  return {
    coins: 50,
    level: 1,
    xp: 0,
    totalHarvests: 0,
    totalEarned: 0,
    plotCount: 2,
    inv: { lettuce: 0, corn: 0, tomato: 0 },
    plots: Array.from({length:2}, (_,i)=>({
      slot:i,
      status:"empty", // empty | growing
      cropId:null,
      plantedAt:null,
      growSec:null,
      reward:null,
      xp:null
    }))
  };
}

let state = load();
let plantSlotPending = null;

function migrateIfNeeded(){
  // If already has per-user save, nothing to do
  if(localStorage.getItem(STORAGE_KEY)) return;

  // Prefer OLD_V2_KEY (newer) then OLD_V1_KEY
  const oldV2 = localStorage.getItem(OLD_V2_KEY);
  if(oldV2){
    localStorage.setItem(STORAGE_KEY, oldV2);
    // optional: keep old key (so other users won't lose it)
    return;
  }

  const oldV1 = localStorage.getItem(OLD_V1_KEY);
  if(oldV1){
    // convert v1 -> v2 format
    try{
      const s1 = JSON.parse(oldV1);
      const s = defaultSave();
      s.coins = s1.coins ?? s.coins;
      s.level = s1.level ?? s.level;
      s.xp = s1.xp ?? s.xp;
      s.totalHarvests = s1.totalHarvests ?? 0;
      s.totalEarned = s1.totalEarned ?? 0;
      s.plotCount = s1.plotCount ?? s.plotCount;
      s.plots = s1.plots ?? s.plots;
      // inv stays 0
      localStorage.setItem(STORAGE_KEY, JSON.stringify(s));
      return;
    }catch(e){}
  }
}

function load(){
  try{
    migrateIfNeeded();

    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw){
      return defaultSave();
    }

    const s = JSON.parse(raw);

    // repair + ensure inv
    if(!s.inv) s.inv = { lettuce:0, corn:0, tomato:0 };
    CROPS.forEach(c=>{ if(typeof s.inv[c.id] !== "number") s.inv[c.id]=0; });

    if(!s.plots || !Array.isArray(s.plots)) return defaultSave();
    if(!s.plotCount) s.plotCount = s.plots.length;

    if(s.plots.length < s.plotCount){
      for(let i=s.plots.length; i<s.plotCount; i++){
        s.plots.push({slot:i,status:"empty",cropId:null,plantedAt:null,growSec:null,reward:null,xp:null});
      }
    } else if(s.plots.length > s.plotCount){
      s.plots = s.plots.slice(0, s.plotCount);
    }
    return s;
  }catch(e){
    return defaultSave();
  }
}

function save(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  renderHeader();
}

function addCoins(n){
  state.coins += n;
  state.totalEarned += Math.max(0, n);
  state.xp += Math.floor(Math.max(0, n) / 20);
  levelUpIfNeeded();
  save();
}

function spendCoins(n){
  if(state.coins < n) return false;
  state.coins -= n;
  save();
  return true;
}

function levelUpIfNeeded(){
  while(state.xp >= 20 * state.level){
    state.xp -= 20 * state.level;
    state.level += 1;
    toast(`Level Up! â­ ${state.level}`);
  }
}

function cropById(id){ return CROPS.find(c=>c.id===id); }

function plotStatus(p){
  if(p.status==="empty") return { label:"Empty", ready:false, remainSec:0 };
  const end = p.plantedAt + p.growSec*1000;
  const remain = (end - now())/1000;
  if(remain <= 0) return { label:"âœ… Ready", ready:true, remainSec:0 };
  return { label:`â³ Growing (${fmtTime(remain)})`, ready:false, remainSec:remain };
}

/* ===== Inventory ops ===== */
function hasSeed(cropId){ return (state.inv[cropId]||0) > 0; }
function addSeed(cropId, qty){
  state.inv[cropId] = (state.inv[cropId]||0) + qty;
  save();
}
function useSeed(cropId){
  if(!hasSeed(cropId)) return false;
  state.inv[cropId] -= 1;
  save();
  return true;
}

function renderHeader(){
  $("coins").textContent = state.coins;
  $("level").textContent = state.level;

  const info = $("tgInfo");
  if(info){
    if(TG_USER_ID){
      const name = [tgUser?.first_name, tgUser?.last_name].filter(Boolean).join(" ");
      const uname = tgUser?.username ? `@${tgUser.username}` : "";
      info.textContent = `âœ… Telegram: ${name} ${uname} (id: ${TG_USER_ID})`;
    }else{
      info.textContent = "âš ï¸ Telegram á€‘á€²á€€á€”á€± á€™á€–á€½á€„á€·á€ºá€›á€á€±á€¸á€•á€« (guest mode)";
    }
  }
}

function renderFarm(){
  const root = $("plots");
  root.innerHTML = "";
  state.plots.forEach(p=>{
    const st = plotStatus(p);
    const crop = p.cropId ? cropById(p.cropId) : null;

    const div = document.createElement("div");
    div.className = "plot";
    div.innerHTML = `
      <div class="row" style="align-items:center">
        <h3>Plot #${p.slot+1}</h3>
        <div class="state">${st.label}</div>
      </div>
      <div class="meta">
        <div>${crop ? `${crop.icon} ${crop.name}` : "â€”"}</div>
        <div>${crop ? `+${p.reward}ğŸ’°` : ""}</div>
      </div>
      <div class="btnrow" id="btnrow-${p.slot}"></div>
    `;
    root.appendChild(div);

    const btnrow = div.querySelector(`#btnrow-${p.slot}`);

    if(p.status === "empty"){
      const plantBtn = document.createElement("button");
      plantBtn.className = "primary";
      plantBtn.textContent = "ğŸŒ± Plant";
      plantBtn.onclick = ()=>openPlantModal(p.slot);
      btnrow.appendChild(plantBtn);

      const invBtn = document.createElement("button");
      invBtn.className = "ghost";
      invBtn.textContent = "ğŸ’ Seeds";
      invBtn.onclick = ()=>{
        const lines = CROPS.map(c=>`${c.icon} ${c.name}: ${state.inv[c.id]||0}`).join("\n");
        alert("Seed Inventory:\n\n" + lines);
      };
      btnrow.appendChild(invBtn);

    } else {
      if(st.ready){
        const harvestBtn = document.createElement("button");
        harvestBtn.className = "primary";
        harvestBtn.textContent = "ğŸ§º Harvest";
        harvestBtn.onclick = ()=>harvest(p.slot);
        btnrow.appendChild(harvestBtn);
      } else {
        const waitBtn = document.createElement("button");
        waitBtn.className = "ghost";
        waitBtn.textContent = "â³ Waiting";
        waitBtn.disabled = true;
        btnrow.appendChild(waitBtn);
      }

      const cancelBtn = document.createElement("button");
      cancelBtn.className = "ghost";
      cancelBtn.textContent = "âœ– Clear";
      cancelBtn.onclick = ()=>clearPlot(p.slot);
      btnrow.appendChild(cancelBtn);
    }
  });

  $("harvests").textContent = state.totalHarvests;
  $("earned").textContent = state.totalEarned;
  $("plotCount").textContent = state.plotCount;
  $("seedTotal").textContent = seedTotal(state.inv);

  $("plotCost").textContent = plotUpgradeCost(state.plotCount);
  $("buyPlotBtn").disabled = state.plotCount >= MAX_PLOTS;
  $("buyPlotBtn").textContent = state.plotCount >= MAX_PLOTS ? "Max plots" : "Buy Plot";
}

function renderShop(){
  const list = $("shopList");
  list.innerHTML = "";
  CROPS.forEach(c=>{
    const owned = state.inv[c.id] || 0;
    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      <div class="row">
        <div>
          <div class="name">${c.icon} ${c.name}</div>
          <div class="desc">Grow: ${fmtTime(c.growSec)} â€¢ Reward: <b>+${c.reward}</b> coins â€¢ XP: +${c.xp}</div>
        </div>
        <div style="text-align:right">
          <div class="price">${c.seedPrice} coins</div>
          <button class="primary">Buy Seed</button>
        </div>
      </div>
      <div class="row">
        <div class="small">Owned: <b>${owned}</b></div>
        <div class="small">Buy adds +1 seed</div>
      </div>
    `;
    card.querySelector("button").onclick = ()=>{
      if(spendCoins(c.seedPrice)){
        addSeed(c.id, 1);
        toast(`Bought ${c.name} seed âœ… (Owned: ${state.inv[c.id]})`);
        renderShop();
      } else {
        toast("Coins á€™á€œá€¯á€¶á€œá€±á€¬á€€á€ºá€•á€« âŒ");
      }
    };
    list.appendChild(card);
  });
}

function openPlantModal(slot){
  plantSlotPending = slot;
  $("modalTitle").textContent = `Choose crop for Plot #${slot+1}`;
  $("modalSub").textContent = `Seeds you own will be shown. Out-of-stock can't be planted.`;
  renderCropPicker();
  $("modalBack").style.display = "flex";
}

function closePlantModal(){
  $("modalBack").style.display = "none";
  plantSlotPending = null;
}

function renderCropPicker(){
  const grid = $("cropGrid");
  grid.innerHTML = "";
  CROPS.forEach(c=>{
    const owned = state.inv[c.id] || 0;
    const ok = owned > 0;

    const card = document.createElement("div");
    card.className = "cropCard";
    card.innerHTML = `
      <div class="cropTop">
        <div class="cropIcon">${c.icon}</div>
        <div class="badge ${ok ? "ok":"bad"}">${ok ? "In stock":"Out of stock"}</div>
      </div>
      <div class="name">${c.name}</div>
      <div class="cropMeta">
        <div>â± ${fmtTime(c.growSec)}</div>
        <div>ğŸ§º +${c.reward}</div>
      </div>
      <div class="cropMeta">
        <div>ğŸ’ Owned: <b>${owned}</b></div>
        <div>â­ +${c.xp}</div>
      </div>
      <div class="cropActions">
        <button class="${ok ? "primary":"mutedBtn"} fullBtn" ${ok ? "" : "disabled"}>
          ğŸŒ± Plant
        </button>
        <button class="ghost">ğŸ›’ Shop</button>
      </div>
    `;

    const plantBtn = card.querySelectorAll("button")[0];
    const shopBtn  = card.querySelectorAll("button")[1];

    plantBtn.onclick = ()=>{
      if(!ok){
        toast("Seed á€™á€›á€¾á€­á€•á€« âŒ Shop á€™á€¾á€¬ á€á€šá€ºá€•á€«");
        return;
      }
      plantFromInventory(plantSlotPending, c.id);
      closePlantModal();
    };

    shopBtn.onclick = ()=>{
      closePlantModal();
      showView("shop");
      renderShop();
      toast("Shop opened ğŸ›’");
    };

    grid.appendChild(card);
  });
}

function plantFromInventory(slot, cropId){
  const p = state.plots[slot];
  if(!p) return;
  if(p.status !== "empty"){ toast("Plot busy"); return; }

  if(!useSeed(cropId)){
    toast("Seed á€™á€›á€¾á€­á€•á€« âŒ");
    return;
  }

  const c = cropById(cropId);
  p.status = "growing";
  p.cropId = c.id;
  p.plantedAt = now();
  p.growSec = c.growSec;
  p.reward = c.reward;
  p.xp = c.xp;

  save();
  renderFarm();
  toast(`Planted ${c.name} ğŸŒ± (Remaining: ${state.inv[c.id]})`);
}

function harvest(slot){
  const p = state.plots[slot];
  if(!p || p.status==="empty") return;
  const st = plotStatus(p);
  if(!st.ready){ toast("Not ready yet"); return; }

  state.totalHarvests += 1;
  state.xp += (p.xp || 0);
  addCoins(p.reward || 0);

  state.plots[slot] = {slot, status:"empty", cropId:null, plantedAt:null, growSec:null, reward:null, xp:null};
  save();
  renderFarm();
  toast("Harvested âœ…");
}

function clearPlot(slot){
  const p = state.plots[slot];
  if(!p) return;
  state.plots[slot] = {slot, status:"empty", cropId:null, plantedAt:null, growSec:null, reward:null, xp:null};
  save();
  renderFarm();
  toast("Cleared");
}

function buyPlot(){
  if(state.plotCount >= MAX_PLOTS){ toast("Max plots"); return; }
  const cost = plotUpgradeCost(state.plotCount);
  if(!spendCoins(cost)){ toast("Coins á€™á€œá€¯á€¶á€œá€±á€¬á€€á€ºá€•á€« âŒ"); return; }
  state.plotCount += 1;
  state.plots.push({slot:state.plotCount-1,status:"empty",cropId:null,plantedAt:null,growSec:null,reward:null,xp:null});
  save();
  renderFarm();
  toast("New plot unlocked âœ…");
}

function resetAll(){
  if(!confirm("Reset game? All progress will be lost.")) return;

  // âœ… remove per-user key only
  localStorage.removeItem(STORAGE_KEY);

  // optional: keep old keys, or delete them too
  // localStorage.removeItem(OLD_V2_KEY);
  // localStorage.removeItem(OLD_V1_KEY);

  state = defaultSave();
  save();
  renderAll();
  toast("Reset done");
}

function exportSave(){
  const txt = btoa(unescape(encodeURIComponent(JSON.stringify(state))));
  prompt("Copy this save string:", txt);
}

function importSave(){
  const txt = prompt("Paste save string:");
  if(!txt) return;
  try{
    const json = decodeURIComponent(escape(atob(txt)));
    const s = JSON.parse(json);
    state = s;
    save();
    renderAll();
    toast("Imported âœ…");
  }catch(e){
    toast("Import failed âŒ");
  }
}

function showView(which){
  const views = { farm:$("viewFarm"), shop:$("viewShop"), profile:$("viewProfile") };
  Object.values(views).forEach(v=>v.style.display="none");
  views[which].style.display="block";

  $("tabFarm").classList.toggle("active", which==="farm");
  $("tabShop").classList.toggle("active", which==="shop");
  $("tabProfile").classList.toggle("active", which==="profile");
}

function wire(){
  $("tabFarm").onclick = ()=>{ showView("farm"); renderFarm(); };
  $("tabShop").onclick = ()=>{ showView("shop"); renderShop(); };
  $("tabProfile").onclick = ()=>{ showView("profile"); renderFarm(); };

  $("buyPlotBtn").onclick = buyPlot;
  $("resetBtn").onclick = resetAll;
  $("exportBtn").onclick = exportSave;
  $("importBtn").onclick = importSave;

  $("modalClose").onclick = closePlantModal;
  $("modalBack").addEventListener("click", (e)=>{
    if(e.target === $("modalBack")) closePlantModal();
  });
}

function renderAll(){
  renderHeader();
  renderFarm();
  renderShop();
}

wire();
renderAll();

// update timers on farm
setInterval(()=>{
  if($("viewFarm").style.display !== "none") renderFarm();
}, 1000);
</script>
</body>
</html>
