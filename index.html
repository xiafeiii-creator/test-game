<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Idle Farm</title>
  <style>
    :root{
      --bg1:#0b1020; --bg2:#0a1a2e;
      --card: rgba(255,255,255,.07);
      --line: rgba(255,255,255,.10);
      --text:#eaf0ff; --muted: rgba(234,240,255,.72);
      --good:#27e1a1; --warn:#ffcc66; --bad:#ff5a7a;
      --accent:#7c5cff; --accent2:#22d3ee;
      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --r: 18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue", "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: var(--sans); color: var(--text);
      background:
        radial-gradient(1200px 700px at 20% 10%, rgba(124,92,255,.22), transparent 55%),
        radial-gradient(900px 600px at 90% 25%, rgba(34,211,238,.18), transparent 55%),
        radial-gradient(1000px 700px at 40% 95%, rgba(39,225,161,.12), transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      min-height: 100vh;
      padding: 16px; padding-bottom: 24px;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    .wrap{max-width: 980px; margin: 0 auto;}
    .top{display:flex; gap:12px; align-items:stretch; flex-wrap:wrap;}
    .brand{
      flex: 1 1 320px;
      background: linear-gradient(135deg, rgba(124,92,255,.22), rgba(34,211,238,.16));
      border:1px solid var(--line);
      border-radius: var(--r);
      padding: 14px 14px 12px 14px;
      box-shadow: var(--shadow);
      position:relative; overflow:hidden;
    }
    .brand:before{
      content:""; position:absolute; inset:-120px -140px auto auto;
      width: 280px; height: 280px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.22), transparent 60%);
      transform: rotate(22deg);
      pointer-events:none;
    }
    .title{display:flex; align-items:center; justify-content:space-between; gap:10px;}
    .title h1{margin:0; font-size: 18px; letter-spacing:.3px;}
    .title .chip{
      font-family: var(--mono); font-size: 12px;
      padding: 6px 10px; border-radius: 999px;
      background: rgba(0,0,0,.25);
      border: 1px solid rgba(255,255,255,.12);
      color: rgba(255,255,255,.85);
      backdrop-filter: blur(6px);
    }
    .sub{margin-top: 8px; display:flex; flex-wrap:wrap; gap:10px; color: var(--muted); font-size: 13px; line-height:1.25;}
    .sub .pill{
      padding: 8px 10px; border-radius: 999px;
      background: rgba(255,255,255,.06); border: 1px solid rgba(255,255,255,.10);
    }

    .stats{
      flex: 1 1 320px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    .card{
      background: var(--card);
      border:1px solid var(--line);
      border-radius: var(--r);
      padding: 12px 12px 10px 12px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(8px);
    }
    .k{font-size: 12px; color: rgba(234,240,255,.75);}
    .v{margin-top: 6px; font-size: 18px; font-family: var(--mono); letter-spacing:.2px;}
    .mini{margin-top: 6px; font-size: 12px; color: rgba(234,240,255,.62);}

    .grid{margin-top: 14px; display:grid; grid-template-columns: 1.35fr .95fr; gap: 12px;}
    @media (max-width: 920px){ .grid{grid-template-columns: 1fr;} }

    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.05));
      border:1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panelHead{
      padding: 12px 12px 10px 12px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.12);
    }
    .panelHead h2{margin:0; font-size: 14px; letter-spacing:.25px; color: rgba(234,240,255,.9);}
    .panelHead .hint{font-size: 12px; color: rgba(234,240,255,.65);}

    .farm{padding: 12px;}
    .field{display:grid; grid-template-columns: repeat(4, 1fr); gap:10px;}
    @media (max-width: 520px){ .field{grid-template-columns: repeat(3, 1fr);} }

    .plot{
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.12);
      background: radial-gradient(circle at 30% 20%, rgba(255,255,255,.10), transparent 55%),
                  linear-gradient(180deg, rgba(0,0,0,.18), rgba(0,0,0,.28));
      padding: 10px 10px 8px 10px;
      min-height: 112px;
      position: relative;
      overflow:hidden;
      cursor:pointer;
      user-select:none;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
      touch-action: manipulation;
    }
    .plot:hover{transform: translateY(-1px); border-color: rgba(255,255,255,.18);}
    .plot:active{transform: translateY(0px) scale(.99);}
    .plot .badge{
      position:absolute; top:10px; right:10px;
      font-family: var(--mono); font-size: 11px;
      padding: 5px 8px; border-radius: 999px;
      background: rgba(0,0,0,.28);
      border:1px solid rgba(255,255,255,.12);
      color: rgba(255,255,255,.85);
    }
    .plot .emoji{font-size: 28px; margin-top: 16px;}
    .plot .name{margin-top: 8px; font-size: 12px; color: rgba(234,240,255,.85);}
    .plot .bar{
      margin-top: 8px; height: 8px; border-radius: 999px;
      background: rgba(255,255,255,.08);
      overflow:hidden;
      border:1px solid rgba(255,255,255,.10);
    }
    .plot .bar > i{
      display:block; height:100%; width:0%;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      border-radius: 999px;
      transition: width .15s linear;
    }
    .plot .foot{
      margin-top: 7px; font-size: 11px; color: rgba(234,240,255,.62);
      display:flex; justify-content:space-between; font-family: var(--mono);
    }

    .controls{padding: 12px; display:grid; gap: 10px;}
    .row{display:flex; gap:10px; flex-wrap:wrap;}
    .btn{
      flex: 1 1 140px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: rgba(234,240,255,.92);
      padding: 12px 12px;
      font-size: 13px;
      cursor:pointer;
      user-select:none;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
      touch-action: manipulation;
    }
    .btn:hover{background: rgba(255,255,255,.08); border-color: rgba(255,255,255,.18);}
    .btn:active{transform: scale(.99);}
    .btn b{font-family: var(--mono); font-weight: 700;}
    .btn .r{font-family: var(--mono); font-size: 12px; color: rgba(234,240,255,.65); white-space:nowrap;}
    .btn.primary{background: linear-gradient(135deg, rgba(124,92,255,.32), rgba(34,211,238,.22));}
    .btn.good{background: linear-gradient(135deg, rgba(39,225,161,.28), rgba(34,211,238,.15));}
    .btn.warn{background: linear-gradient(135deg, rgba(255,204,102,.22), rgba(124,92,255,.12));}
    .btn.bad{background: linear-gradient(135deg, rgba(255,90,122,.22), rgba(124,92,255,.12));}

    .shop{padding: 12px; display:grid; gap: 10px;}
    .item{
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      padding: 12px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .item .l{display:flex; align-items:center; gap:10px;}
    .item .ico{font-size: 22px;}
    .item .t{display:flex; flex-direction:column; gap:3px;}
    .item .t .n{font-size: 13px;}
    .item .t .d{font-size: 12px; color: rgba(234,240,255,.62);}
    .item .buy{
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      padding: 10px 12px;
      cursor:pointer;
      user-select:none;
      display:flex; align-items:center; gap:10px;
      transition: transform .12s ease, border-color .12s ease, background .12s ease;
      touch-action: manipulation;
    }
    .item .buy:hover{border-color: rgba(255,255,255,.22); background: rgba(0,0,0,.22);}
    .item .buy:active{transform: scale(.99);}
    .item .buy .p{font-family: var(--mono); font-size: 12px; color: rgba(234,240,255,.8);}
    .item .buy .b{font-family: var(--mono); font-weight:700; font-size: 12px; color: var(--good);}

    .split{
      display:grid; gap:10px; padding:12px;
      grid-template-columns: 1fr;
    }
    .line{height:1px; background: rgba(255,255,255,.10); margin: 6px 0;}
    .miniRow{display:flex; justify-content:space-between; gap:12px; font-size:12px; color: rgba(234,240,255,.72); font-family: var(--mono);}
    .tag{
      font-size:11px; padding:3px 8px; border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      color: rgba(234,240,255,.72);
      background: rgba(255,255,255,.04);
      font-family: var(--mono);
    }
    .tag.good{border-color: rgba(39,225,161,.35); color: rgba(39,225,161,.95); background: rgba(39,225,161,.08);}
    .tag.warn{border-color: rgba(255,204,102,.35); color: rgba(255,204,102,.95); background: rgba(255,204,102,.08);}
    .tag.bad{border-color: rgba(255,90,122,.35); color: rgba(255,90,122,.95); background: rgba(255,90,122,.08);}

    .toast{
      position: fixed;
      left: 50%;
      bottom: 14px;
      transform: translateX(-50%);
      background: rgba(0,0,0,.55);
      border: 1px solid rgba(255,255,255,.14);
      color: rgba(255,255,255,.9);
      padding: 10px 12px;
      border-radius: 999px;
      font-size: 12px;
      opacity: 0;
      pointer-events:none;
      transition: opacity .18s ease, transform .18s ease;
      backdrop-filter: blur(8px);
      box-shadow: 0 14px 40px rgba(0,0,0,.35);
      max-width: min(520px, calc(100vw - 24px));
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      z-index: 999;
    }
    .toast.show{opacity: 1; transform: translateX(-50%) translateY(-4px);}

    .footer{
      margin-top: 12px;
      text-align:center;
      color: rgba(234,240,255,.52);
      font-size: 12px;
    }
    .footer code{font-family: var(--mono); color: rgba(234,240,255,.75);}

    /* Small modal */
    .modalBack{
      position:fixed; inset:0; background:rgba(0,0,0,.58);
      display:none; align-items:flex-end; justify-content:center;
      z-index: 1000;
    }
    .modal{
      width:min(920px,100%);
      max-height:82vh;
      overflow:auto;
      background: rgba(20,22,33,.98);
      border-top: 1px solid rgba(255,255,255,.12);
      border-left: 1px solid rgba(255,255,255,.06);
      border-right: 1px solid rgba(255,255,255,.06);
      border-radius: 18px 18px 0 0;
      padding: 14px 14px 16px;
    }
    .modalHead{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px;}
    .modalHead b{font-size:14px;}
    .closeX{
      width:40px; height:40px;
      border-radius:12px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      color: rgba(234,240,255,.92);
      cursor:pointer;
      touch-action: manipulation;
    }
    .cropGrid{display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:12px;}
    @media (min-width:720px){ .cropGrid{grid-template-columns: repeat(3, minmax(0,1fr)); } }
    .cropCard{
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.10);
      border-radius:16px;
      padding:12px;
      display:flex; flex-direction:column; gap:8px;
    }
    .cropTop{display:flex; justify-content:space-between; align-items:center; gap:10px;}
    .cropIcon{font-size:22px;}
    .cropName{font-weight:900; font-size:14px;}
    .cropMeta{display:flex; justify-content:space-between; gap:10px; font-size:12px; color: rgba(234,240,255,.68); font-family: var(--mono);}
    .cropBtns{display:flex; gap:8px; margin-top:6px;}
    .fullBtn{
      flex:1;
      border-radius:12px;
      padding:10px 10px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: rgba(234,240,255,.92);
      cursor:pointer;
      font-weight:900;
      touch-action: manipulation;
    }
    .fullBtn.primary{
      background: rgba(39,225,161,.90);
      color:#07110a;
      border-color: rgba(39,225,161,.35);
    }
    .fullBtn:disabled{
      opacity:.55;
      cursor:not-allowed;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="title">
          <h1>üåæ Idle Farm</h1>
          <div class="chip" id="farmIdChip">farm#000000</div>
        </div>
        <div class="sub">
          <div class="pill">Tap plot ‚Üí Plant / Harvest</div>
          <div class="pill">Offline idle + Save</div>
          <div class="pill">Prestige at lvl 15</div>
        </div>
      </div>

      <div class="stats">
        <div class="card">
          <div class="k">Coins</div>
          <div class="v" id="coins">0</div>
          <div class="mini">Earn by harvesting crops</div>
        </div>
        <div class="card">
          <div class="k">Level</div>
          <div class="v" id="level">1</div>
          <div class="mini" id="xpLine">XP 0 / 100</div>
        </div>
        <div class="card">
          <div class="k">Harvests</div>
          <div class="v" id="harvests">0</div>
          <div class="mini">Total harvest count</div>
        </div>
        <div class="card">
          <div class="k">Prestige</div>
          <div class="v"><span id="prestige">0</span> ‚ú®</div>
          <div class="mini"><span id="pp">0</span> PP ‚Ä¢ Auto: <span id="autoTag">OFF</span></div>
        </div>
      </div>
    </div>

    <div class="grid">
      <div class="panel">
        <div class="panelHead">
          <h2>üß© Field (<span id="plotLabel">12</span> plots)</h2>
          <div class="hint">Hold growth offline (cap 12h)</div>
        </div>
        <div class="farm">
          <div class="field" id="field"></div>
        </div>
      </div>

      <div class="panel">
        <div class="panelHead">
          <h2>üõ†Ô∏è Actions</h2>
          <div class="hint">Tap buttons (touch ready)</div>
        </div>

        <div class="controls">
          <div class="row">
            <div class="btn primary" id="btnPlantAll">
              <span>üå± Plant All</span>
              <span class="r">Choose crop</span>
            </div>
            <div class="btn good" id="btnHarvestAll">
              <span>üß∫ Harvest All</span>
              <span class="r">Ready only</span>
            </div>
          </div>

          <div class="row">
            <div class="btn warn" id="btnBoost">
              <span>‚ö° Boost 30s</span>
              <span class="r"><b id="boostPrice">150</b> coins</span>
            </div>
            <div class="btn bad" id="btnReset">
              <span>‚ôªÔ∏è Reset</span>
              <span class="r">Clear save</span>
            </div>
          </div>

          <div class="row">
            <div class="btn good" id="btnDaily">
              <span>üéÅ Daily Reward</span>
              <span class="r" id="dailyTag">Check</span>
            </div>
            <div class="btn primary" id="btnQuests">
              <span>üìú Quests</span>
              <span class="r" id="questTag">0/3</span>
            </div>
          </div>

          <div class="row">
            <div class="btn warn" id="btnPrestige">
              <span>‚ú® Prestige</span>
              <span class="r" id="prestigeTag">Locked</span>
            </div>
            <div class="btn primary" id="btnSaveTools">
              <span>üíæ Save Tools</span>
              <span class="r">Export/Import</span>
            </div>
          </div>
        </div>

        <div class="panelHead" style="border-top:1px solid rgba(255,255,255,.08);">
          <h2>üõí Shop</h2>
          <div class="hint">Upgrades + automation</div>
        </div>

        <div class="shop">
          <div class="item">
            <div class="l">
              <div class="ico">üßë‚Äçüåæ</div>
              <div class="t">
                <div class="n">Farmer Speed</div>
                <div class="d">Grow faster (+10%)</div>
              </div>
            </div>
            <div class="buy" data-buy="speed">
              <span class="p">Price</span>
              <span class="b" id="priceSpeed">200</span>
            </div>
          </div>

          <div class="item">
            <div class="l">
              <div class="ico">üí∞</div>
              <div class="t">
                <div class="n">Better Yield</div>
                <div class="d">More coins (+15%)</div>
              </div>
            </div>
            <div class="buy" data-buy="yield">
              <span class="p">Price</span>
              <span class="b" id="priceYield">260</span>
            </div>
          </div>

          <div class="item">
            <div class="l">
              <div class="ico">üß∫</div>
              <div class="t">
                <div class="n">Extra Plot</div>
                <div class="d">Add 1 plot (max 16)</div>
              </div>
            </div>
            <div class="buy" data-buy="plot">
              <span class="p">Price</span>
              <span class="b" id="pricePlot">320</span>
            </div>
          </div>

          <div class="item">
            <div class="l">
              <div class="ico">ü§ñ</div>
              <div class="t">
                <div class="n">Auto Farmer</div>
                <div class="d">Auto harvest + auto plant</div>
              </div>
            </div>
            <div class="buy" data-buy="auto">
              <span class="p">Price</span>
              <span class="b" id="priceAuto">1 PP</span>
            </div>
          </div>
        </div>

        <div class="split">
          <div class="miniRow"><span>Selected Crop</span><span id="selCrop">‚Äî</span></div>
          <div class="miniRow"><span>Streak</span><span id="streak">0</span></div>
          <div class="miniRow"><span>Achievements</span><span id="achCount">0</span></div>
        </div>
      </div>
    </div>

    <div class="footer">
      Saved in <code>localStorage</code> ‚Ä¢ Offline cap <code>12h</code> ‚Ä¢ Version <code>2.0</code>
    </div>
  </div>

  <div class="toast" id="toast">Hello</div>

  <!-- Modal: Crop picker -->
  <div class="modalBack" id="modalBack">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalHead">
        <div>
          <b id="modalTitle">Choose a crop</b><br>
          <small style="color:rgba(234,240,255,.65)" id="modalSub">Pick crop to plant</small>
        </div>
        <button class="closeX" id="modalClose">‚úï</button>
      </div>
      <div class="cropGrid" id="cropGrid"></div>
      <div style="margin-top:10px; color:rgba(234,240,255,.68); font-size:12px;">
        Tip: Higher crops unlock as your level increases.
      </div>
    </div>
  </div>

  <script>
  /***************
   * Idle Farm v2 (single-file)
   * - Prestige at level 15 (default)
   * - Offline cap 12h (default)
   * - Daily + Quests + Achievements
   * - Auto Farmer unlock (PP)
   * - Export/Import save
   ***************/

  // Safe storage (fallback if localStorage blocked)
  const store = (() => {
    try {
      const t="__t__";
      localStorage.setItem(t,"1");
      localStorage.removeItem(t);
      return localStorage;
    } catch(e) {
      let mem = {};
      return {
        getItem:k => (k in mem ? mem[k] : null),
        setItem:(k,v)=>{ mem[k]=String(v); },
        removeItem:k=>{ delete mem[k]; }
      };
    }
  })();

  const STORAGE_KEY = "idleFarmSave_v2";
  const now = () => Date.now();
  const DAY_MS = 24*60*60*1000;

  // Default tuning
  const PRESTIGE_UNLOCK_LVL = 20;
  const OFFLINE_CAP_MS = 12 * 60 * 60 * 1000; // 12h
  const MAX_PLOTS = 20;
  const BASE_PLOTS = 12;

  const CROPS = [
    { id:"wheat", name:"Wheat", emoji:"üåæ", growMs: 12000, base: 18, unlockLvl: 1 },
    { id:"corn",  name:"Corn",  emoji:"üåΩ", growMs: 22000, base: 34, unlockLvl: 6 },
    { id:"rice",  name:"Rice",  emoji:"üçö", growMs: 32000, base: 56, unlockLvl: 12 },
    { id:"carrot",name:"Carrot",emoji:"ü•ï", growMs: 52000, base: 92, unlockLvl: 16 },
    { id:"tomato",name:"Tomato",emoji:"üçÖ", growMs: 85000, base: 150, unlockLvl: 20 },
  ];

  const $ = (id)=>document.getElementById(id);

  const ui = {
    field: $("field"),
    coins: $("coins"),
    level: $("level"),
    xpLine: $("xpLine"),
    harvests: $("harvests"),
    prestige: $("prestige"),
    pp: $("pp"),
    autoTag: $("autoTag"),
    plotLabel: $("plotLabel"),
    farmIdChip: $("farmIdChip"),
    toast: $("toast"),
    btnPlantAll: $("btnPlantAll"),
    btnHarvestAll: $("btnHarvestAll"),
    btnBoost: $("btnBoost"),
    boostPrice: $("boostPrice"),
    btnReset: $("btnReset"),
    btnDaily: $("btnDaily"),
    dailyTag: $("dailyTag"),
    btnQuests: $("btnQuests"),
    questTag: $("questTag"),
    btnPrestige: $("btnPrestige"),
    prestigeTag: $("prestigeTag"),
    btnSaveTools: $("btnSaveTools"),
    priceSpeed: $("priceSpeed"),
    priceYield: $("priceYield"),
    pricePlot: $("pricePlot"),
    priceAuto: $("priceAuto"),
    selCrop: $("selCrop"),
    streak: $("streak"),
    achCount: $("achCount"),
    modalBack: $("modalBack"),
    modalClose: $("modalClose"),
    modalTitle: $("modalTitle"),
    modalSub: $("modalSub"),
    cropGrid: $("cropGrid"),
  };

  function format(n){ return Math.floor(n).toLocaleString("en-US"); }

  function toast(msg){
    ui.toast.textContent = msg;
    ui.toast.classList.add("show");
    clearTimeout(toast._t);
    toast._t = setTimeout(()=>ui.toast.classList.remove("show"), 1400);
  }

  function genFarmId(){
    const base = Math.floor(Math.random() * 900000) + 100000;
    return "farm#" + base;
  }

  function defaultSave(){
    return {
      v: 2,
      farmId: genFarmId(),
      coins: 120,
      level: 1,
      xp: 0,
      xpNeed: 100,
      harvests: 0,

      upgrades: { speed: 0, yield: 0 },
      maxPlots: BASE_PLOTS,
      plots: Array.from({length: BASE_PLOTS}, ()=>({ crop:null, plantedAt:0, readyAt:0 })),

      boostUntil: 0,

      // prestige
      prestige: 0,
      pp: 0, // prestige points
      autoFarmer: false,

      // meta
      selectedCrop: "wheat",
      lastTick: now(),

      // daily + streak
      daily: { lastDayKey: "", streak: 0 },

      // quests & achievements
      quests: makeQuests(1),
      achievements: {
        h10:false, h100:false, h1000:false,
        c1k:false, c10k:false, c100k:false,
        p1:false
      }
    };
  }

  function load(){
    try{
      const raw = store.getItem(STORAGE_KEY);
      if(!raw) return defaultSave();
      const s = JSON.parse(raw);
      if(!s || !Array.isArray(s.plots)) return defaultSave();
      // migrations
      if(!s.v) s.v = 2;
      if(!s.farmId) s.farmId = genFarmId();
      if(!s.daily) s.daily = { lastDayKey:"", streak:0 };
      if(!s.quests) s.quests = makeQuests(s.level||1);
      if(!s.achievements) s.achievements = defaultSave().achievements;
      if(typeof s.pp !== "number") s.pp = 0;
      if(typeof s.prestige !== "number") s.prestige = 0;
      if(typeof s.autoFarmer !== "boolean") s.autoFarmer = false;
      if(!s.selectedCrop) s.selectedCrop = "wheat";
      if(!s.upgrades) s.upgrades = { speed:0, yield:0 };
      if(!s.maxPlots) s.maxPlots = s.plots.length || BASE_PLOTS;

      normalizePlots(s);
      return s;
    }catch(e){
      return defaultSave();
    }
  }

  function save(){
    state.lastTick = now();
    store.setItem(STORAGE_KEY, JSON.stringify(state));
  }

  function normalizePlots(s){
    const want = clamp(s.maxPlots || BASE_PLOTS, BASE_PLOTS, MAX_PLOTS);
    s.maxPlots = want;

    if(s.plots.length < want){
      while(s.plots.length < want) s.plots.push({ crop:null, plantedAt:0, readyAt:0 });
    }else if(s.plots.length > want){
      s.plots = s.plots.slice(0, want);
    }
  }

  function clamp(n,a,b){ return Math.max(a, Math.min(b,n)); }

  function cropById(id){ return CROPS.find(c=>c.id===id) || CROPS[0]; }
  function isUnlockedCrop(c){ return (state.level||1) >= (c.unlockLvl||1); }

  function speedMultiplier(){
    const u = state.upgrades.speed || 0;
    let m = 1 - (u * 0.10);
    m = clamp(m, 0.40, 1);
    // prestige permanent
    const pm = 1 - (state.prestige * 0.02);
    m = clamp(m * pm, 0.25, 1);
    if(now() < state.boostUntil) m *= 0.70;
    return m;
  }

  function yieldMultiplier(){
    const u = state.upgrades.yield || 0;
    let m = 1 + (u * 0.15);
    // prestige permanent
    m *= (1 + state.prestige * 0.03);
    return m;
  }

  function plotUpgradeCost(){
    const n = state.maxPlots - BASE_PLOTS;
    return Math.floor(320 * Math.pow(1.55, Math.max(0,n)));
  }

  function calcPrices(){
    const s = state.upgrades.speed || 0;
    const y = state.upgrades.yield || 0;

    const priceSpeed = Math.floor(200 * Math.pow(1.45, s));
    const priceYield = Math.floor(260 * Math.pow(1.45, y));
    const pricePlot  = plotUpgradeCost();
    const boostPrice = Math.floor(150 * Math.pow(1.25, Math.max(0, state.level-1)));

    ui.priceSpeed.textContent = format(priceSpeed);
    ui.priceYield.textContent = format(priceYield);
    ui.pricePlot.textContent  = format(pricePlot);
    ui.boostPrice.textContent = format(boostPrice);
    ui.priceAuto.textContent = state.autoFarmer ? "Owned" : "1 PP";

    return { priceSpeed, priceYield, pricePlot, boostPrice };
  }

  function isReady(p){ return p.crop && now() >= p.readyAt; }

  function plant(plotIndex, cropId){
    const p = state.plots[plotIndex];
    if(!p || p.crop) return false;

    const crop = cropById(cropId);
    if(!isUnlockedCrop(crop)) return false;

    const sm = speedMultiplier();
    const growMs = Math.floor(crop.growMs * sm);

    p.crop = crop.id;
    p.plantedAt = now();
    p.readyAt = p.plantedAt + growMs;
    return true;
  }

  function addXP(xp){
    state.xp += xp;
    while(state.xp >= state.xpNeed){
      state.xp -= state.xpNeed;
      state.level += 1;
      state.xpNeed = Math.floor(state.xpNeed * 1.18 + 20);
      toast(`üéâ Level Up! ‚≠ê ${state.level}`);
      // refresh quests tier sometimes
      if(state.level % 5 === 0) state.quests = makeQuests(state.level);
    }
  }

  function harvest(plotIndex){
    const p = state.plots[plotIndex];
    if(!p || !isReady(p)) return 0;

    const crop = cropById(p.crop);
    const coins = Math.floor(crop.base * yieldMultiplier());

    state.coins += coins;
    state.harvests += 1;

    const xpGain = 10 + Math.floor(crop.base / 6);
    addXP(xpGain);

    // clear plot
    p.crop = null; p.plantedAt = 0; p.readyAt = 0;
    return coins;
  }

  function estimateProfitPerMinute(){
    let perMin = 0;
    const sm = speedMultiplier();
    for(const p of state.plots){
      if(!p.crop) continue;
      const c = cropById(p.crop);
      const growMs = Math.floor(c.growMs * sm);
      const value = Math.floor(c.base * yieldMultiplier());
      perMin += value * (60000 / growMs);
    }
    return Math.floor(perMin);
  }

  // Better Offline Idle: multiple cycles (capped)
  function applyOfflineIdle(){
    const last = state.lastTick || now();
    let dt = Math.max(0, now() - last);
    dt = Math.min(dt, OFFLINE_CAP_MS);

    if(dt < 4000) return;

    let earned = 0;
    let cycles = 0;

    const sm = speedMultiplier();

    for(let i=0;i<state.plots.length;i++){
      const p = state.plots[i];
      if(!p.crop) continue;

      const c = cropById(p.crop);
      const growMs = Math.floor(c.growMs * sm);

      // how many harvest cycles completed since last tick?
      const timeSincePlant = (last <= p.plantedAt) ? dt : (now() - p.plantedAt);
      const doneCycles = Math.floor(timeSincePlant / growMs);

      if(doneCycles <= 0) continue;

      // Cap per plot to avoid crazy numbers offline
      const capPerPlot = 50;
      const n = Math.min(doneCycles, capPerPlot);

      const value = Math.floor(c.base * yieldMultiplier());
      earned += value * n;
      cycles += n;

      // keep plot planted, but move timestamps forward
      // simulate it is still growing with remainder
      const remainder = timeSincePlant % growMs;
      p.plantedAt = now() - remainder;
      p.readyAt = p.plantedAt + growMs;
    }

    if(earned > 0){
      state.coins += earned;
      toast(`üõå Offline: +${format(earned)} coins (${cycles} cycles)`);
    }
  }

  // Daily system
  function dayKey(t){
    const d = new Date(t);
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
  }

  function dailyStatus(){
    const today = dayKey(now());
    const last = state.daily.lastDayKey || "";
    if(last === today) return "CLAIMED";
    return "READY";
  }

  function claimDaily(){
    const st = dailyStatus();
    if(st !== "READY"){ toast("Daily already claimed ‚úÖ"); return; }

    const today = dayKey(now());
    const last = state.daily.lastDayKey || "";
    // streak logic: if last day is yesterday -> +1 else reset
    let streak = state.daily.streak || 0;

    if(last){
      const lastDate = new Date(last + "T00:00:00");
      const todayDate = new Date(today + "T00:00:00");
      const diffDays = Math.round((todayDate - lastDate) / DAY_MS);
      if(diffDays === 1) streak += 1;
      else streak = 1;
    }else{
      streak = 1;
    }

    state.daily.lastDayKey = today;
    state.daily.streak = streak;

    const reward = Math.floor(120 + (streak * 35) + (state.level * 8) + (state.prestige*25));
    state.coins += reward;

    toast(`üéÅ Daily +${format(reward)} coins (Streak ${streak})`);
    save(); renderAll();
  }

  // Quests & Achievements
  function makeQuests(level){
    // 3 quests
    const tier = Math.max(1, Math.floor(level / 5));
    const q1 = { id:"harv",  name:"Harvest crops", goal: 20*tier, prog:0, reward: 180*tier };
    const q2 = { id:"earn",  name:"Earn coins",    goal: 1500*tier, prog:0, reward: 260*tier };
    const q3 = { id:"plant", name:"Plant crops",   goal: 30*tier, prog:0, reward: 220*tier };
    return [q1,q2,q3];
  }

  function questProgressText(){
    const done = state.quests.filter(q=>q.prog>=q.goal).length;
    return `${done}/3`;
  }

  function addQuestProgress(type, amount){
    for(const q of state.quests){
      if(q.id === type && q.prog < q.goal){
        q.prog = Math.min(q.goal, q.prog + amount);
      }
    }
  }

  function tryClaimQuests(){
    let claimed = 0;
    let coins = 0;
    for(const q of state.quests){
      if(q.prog >= q.goal && !q.claimed){
        q.claimed = true;
        claimed++;
        coins += q.reward;
      }
    }
    if(claimed){
      state.coins += coins;
      toast(`üìú Claimed ${claimed} quest(s) +${format(coins)} coins`);
      // refresh quests when all claimed
      if(state.quests.every(q=>q.claimed)) state.quests = makeQuests(state.level);
    }else{
      toast("No quests ready");
    }
    save(); renderAll();
  }

  function checkAchievements(){
    const a = state.achievements;

    const h = state.harvests || 0;
    if(!a.h10 && h >= 10){ a.h10=true; toast("üèÖ Achievement: 10 Harvests"); }
    if(!a.h100 && h >= 100){ a.h100=true; toast("üèÖ Achievement: 100 Harvests"); }
    if(!a.h1000 && h >= 1000){ a.h1000=true; toast("üèÖ Achievement: 1000 Harvests"); }

    const c = state.coins || 0;
    if(!a.c1k && c >= 1000){ a.c1k=true; toast("üèÖ Achievement: 1k Coins"); }
    if(!a.c10k && c >= 10000){ a.c10k=true; toast("üèÖ Achievement: 10k Coins"); }
    if(!a.c100k && c >= 100000){ a.c100k=true; toast("üèÖ Achievement: 100k Coins"); }

    if(!a.p1 && state.prestige >= 1){ a.p1=true; toast("üèÖ Achievement: First Prestige"); }
  }

  function achievementCount(){
    const a = state.achievements;
    return Object.values(a).filter(Boolean).length;
  }

  // Prestige
  function canPrestige(){
    return (state.level || 1) >= PRESTIGE_UNLOCK_LVL;
  }

  function prestigeGainEstimate(){
    if(!canPrestige()) return 0;
    // simple: based on level above unlock + total harvests
    const lvl = state.level || 1;
    const extra = Math.max(0, lvl - PRESTIGE_UNLOCK_LVL);
    const base = 1 + Math.floor(extra / 3);
    const bonus = Math.floor((state.harvests || 0) / 250);
    return Math.max(1, base + bonus);
  }

  function doPrestige(){
    if(!canPrestige()){ toast(`Prestige unlock at lvl ${PRESTIGE_UNLOCK_LVL}`); return; }

    const gain = prestigeGainEstimate();
    const ok = confirm(`Prestige now?\n\nYou gain ${gain} PP.\nYour farm resets but you keep Prestige permanent boosts.\n\nProceed?`);
    if(!ok) return;

    const keepPrestige = (state.prestige || 0) + 1;
    const keepPP = (state.pp || 0) + gain;

    // reset
    const fresh = defaultSave();
    fresh.farmId = state.farmId; // keep device identity
    fresh.prestige = keepPrestige;
    fresh.pp = keepPP;
    fresh.autoFarmer = state.autoFarmer; // keep if owned

    state = fresh;

    toast(`‚ú® Prestige +${gain} PP`);
    save(); renderAll();
  }

  // Save tools
  function exportSave(){
    try{
      const txt = btoa(unescape(encodeURIComponent(JSON.stringify(state))));
      prompt("Copy your save string:", txt);
    }catch(e){
      toast("Export failed");
    }
  }
  function importSave(){
    const txt = prompt("Paste save string:");
    if(!txt) return;
    try{
      const json = decodeURIComponent(escape(atob(txt)));
      const s = JSON.parse(json);
      if(!s || !Array.isArray(s.plots)) throw new Error("bad");
      state = s;
      normalizePlots(state);
      toast("Imported ‚úÖ");
      save(); renderAll();
    }catch(e){
      toast("Import failed ‚ùå");
    }
  }

  // Crop modal
  let modalMode = "plantAll"; // plantAll | plantSlot
  let pendingSlot = -1;

  function openCropModal(mode, slot=-1){
    modalMode = mode;
    pendingSlot = slot;

    ui.modalTitle.textContent = (mode === "plantSlot")
      ? `Choose crop for Plot #${slot+1}`
      : "Choose crop to Plant All";

    ui.modalSub.textContent = "Locked crops unlock with level.";
    renderCropGrid();
    ui.modalBack.style.display = "flex";
  }
  function closeCropModal(){
    ui.modalBack.style.display = "none";
    pendingSlot = -1;
  }

  function renderCropGrid(){
    ui.cropGrid.innerHTML = "";
    for(const c of CROPS){
      const unlocked = isUnlockedCrop(c);
      const card = document.createElement("div");
      card.className = "cropCard";
      card.innerHTML = `
        <div class="cropTop">
          <div class="cropIcon">${c.emoji}</div>
          <span class="tag ${unlocked ? "good":"bad"}">${unlocked ? "Unlocked":"Locked"}</span>
        </div>
        <div class="cropName">${c.name}</div>
        <div class="cropMeta"><span>Lvl ${c.unlockLvl}+</span><span>‚è± ${(c.growMs/1000).toFixed(0)}s</span></div>
        <div class="cropMeta"><span>üß∫ +${format(Math.floor(c.base * yieldMultiplier()))}</span><span>Speed x${(1/speedMultiplier()).toFixed(2)}</span></div>
        <div class="cropBtns">
          <button class="fullBtn primary" ${unlocked ? "" : "disabled"}>Select</button>
          <button class="fullBtn" data-why="info">Info</button>
        </div>
      `;
      const selectBtn = card.querySelectorAll("button")[0];
      const infoBtn = card.querySelectorAll("button")[1];

      selectBtn.addEventListener("click", ()=>chooseCrop(c.id));
      selectBtn.addEventListener("touchstart", (e)=>{ e.preventDefault(); chooseCrop(c.id); }, {passive:false});

      infoBtn.addEventListener("click", ()=>{
        toast(`${c.emoji} ${c.name}: grow ${(c.growMs/1000).toFixed(0)}s ‚Ä¢ base ${c.base}`);
      });
      infoBtn.addEventListener("touchstart", (e)=>{ e.preventDefault(); toast(`${c.emoji} ${c.name}: grow ${(c.growMs/1000).toFixed(0)}s ‚Ä¢ base ${c.base}`); }, {passive:false});

      ui.cropGrid.appendChild(card);
    }
  }

  function chooseCrop(cropId){
    state.selectedCrop = cropId;
    if(modalMode === "plantAll"){
      plantAll(cropId);
    }else if(modalMode === "plantSlot" && pendingSlot >= 0){
      const ok = plant(pendingSlot, cropId);
      if(ok){
        addQuestProgress("plant", 1);
        toast(`üå± Planted ${cropById(cropId).name}`);
      }else{
        toast("Can't plant here");
      }
      save(); renderAll();
    }
    closeCropModal();
  }

  // Bulk actions
  function plantAll(cropId){
    let planted = 0;
    for(let i=0;i<state.plots.length;i++){
      if(!state.plots[i].crop){
        if(plant(i, cropId)) planted++;
      }
    }
    if(planted){
      addQuestProgress("plant", planted);
      toast(`üå± Planted ${planted} plots`);
    }else{
      toast("No empty plots");
    }
    save(); renderAll();
  }

  function harvestAll(){
    let earned = 0, c = 0;
    for(let i=0;i<state.plots.length;i++){
      if(isReady(state.plots[i])){
        const got = harvest(i);
        if(got>0){ earned += got; c++; }
      }
    }
    if(c){
      addQuestProgress("harv", c);
      addQuestProgress("earn", earned);
      toast(`üß∫ +${format(earned)} coins (${c})`);
    }else{
      toast("Nothing ready");
    }
    checkAchievements();
    save(); renderAll();
  }

  // Auto farmer
  function autoTick(){
    if(!state.autoFarmer) return;
    // harvest ready
    let earned = 0, h = 0;
    for(let i=0;i<state.plots.length;i++){
      if(isReady(state.plots[i])){
        const got = harvest(i);
        if(got>0){ earned += got; h++; }
      }
    }
    if(h){
      addQuestProgress("harv", h);
      addQuestProgress("earn", earned);
    }
    // plant empty using selected crop
    const cropId = state.selectedCrop || "wheat";
    for(let i=0;i<state.plots.length;i++){
      if(!state.plots[i].crop){
        if(plant(i, cropId)){
          addQuestProgress("plant", 1);
        }
      }
    }
    checkAchievements();
    save();
  }

  // Shop buy
  function buy(type){
    const prices = calcPrices();
    if(type === "speed"){
      if(state.coins < prices.priceSpeed) return toast("Coins not enough ‚ùå");
      state.coins -= prices.priceSpeed;
      state.upgrades.speed = (state.upgrades.speed||0) + 1;
      toast("üßë‚Äçüåæ Speed upgraded!");
    }
    if(type === "yield"){
      if(state.coins < prices.priceYield) return toast("Coins not enough ‚ùå");
      state.coins -= prices.priceYield;
      state.upgrades.yield = (state.upgrades.yield||0) + 1;
      toast("üí∞ Yield upgraded!");
    }
    if(type === "plot"){
      if(state.maxPlots >= MAX_PLOTS) return toast("Max plots ‚úÖ");
      if(state.coins < prices.pricePlot) return toast("Coins not enough ‚ùå");
      state.coins -= prices.pricePlot;
      state.maxPlots += 1;
      normalizePlots(state);
      toast("üß∫ New plot unlocked!");
    }
    if(type === "auto"){
      if(state.autoFarmer) return toast("Already owned ‚úÖ");
      if(state.pp < 1) return toast("Need 1 PP (Prestige) ‚ùå");
      state.pp -= 1;
      state.autoFarmer = true;
      toast("ü§ñ Auto Farmer unlocked!");
    }
    save(); renderAll();
  }

  // Boost, reset
  function boost(){
    const { boostPrice } = calcPrices();
    if(now() < state.boostUntil) return toast("Boost already active ‚ö°");
    if(state.coins < boostPrice) return toast("Coins not enough ‚ùå");
    state.coins -= boostPrice;
    state.boostUntil = now() + 30000;
    toast("‚ö° Boost 30s!");
    save(); renderAll();
  }

  function resetAll(){
    const ok = confirm("Reset game? All progress will be lost.");
    if(!ok) return;
    store.removeItem(STORAGE_KEY);
    state = defaultSave();
    toast("Reset done");
    save(); renderAll();
  }

  // Render
  function renderHeader(){
    ui.farmIdChip.textContent = state.farmId || "farm#??????";
    ui.coins.textContent = format(state.coins);
    ui.level.textContent = format(state.level);
    ui.xpLine.textContent = `XP ${format(state.xp)} / ${format(state.xpNeed)}`;
    ui.harvests.textContent = format(state.harvests);

    ui.prestige.textContent = format(state.prestige);
    ui.pp.textContent = format(state.pp);
    ui.autoTag.textContent = state.autoFarmer ? "ON" : "OFF";
    ui.plotLabel.textContent = state.maxPlots;

    ui.selCrop.textContent = `${cropById(state.selectedCrop).emoji} ${cropById(state.selectedCrop).name}`;
    ui.streak.textContent = format(state.daily.streak || 0);
    ui.achCount.textContent = format(achievementCount());

    ui.dailyTag.textContent = (dailyStatus()==="READY") ? "READY" : "CLAIMED";
    ui.questTag.textContent = questProgressText();

    if(canPrestige()){
      ui.prestigeTag.textContent = `Gain ~${prestigeGainEstimate()} PP`;
    }else{
      ui.prestigeTag.textContent = `Locked (lvl ${PRESTIGE_UNLOCK_LVL})`;
    }
  }

  function renderFarm(){
    normalizePlots(state);
    ui.field.innerHTML = "";

    const sm = speedMultiplier();

    state.plots.forEach((p, idx) => {
      const el = document.createElement("div");
      el.className = "plot";

      let badge = "#" + (idx+1);
      let emoji = "üü´";
      let name = "Empty";
      let bar = 0;
      let footL = "tap: plant";
      let footR = "";

      if(p.crop){
        const c = cropById(p.crop);
        emoji = c.emoji;
        name = c.name;

        const total = Math.max(1, p.readyAt - p.plantedAt);
        const done = clamp(now() - p.plantedAt, 0, total);
        bar = (done / total) * 100;

        if(isReady(p)){
          badge = "READY";
          footL = "tap: harvest";
          footR = "+" + format(Math.floor(c.base * yieldMultiplier()));
          bar = 100;
        }else{
          const left = Math.max(0, p.readyAt - now());
          footL = "growing";
          footR = (left/1000).toFixed(0) + "s";
        }
      }else{
        const sc = cropById(state.selectedCrop);
        emoji = sc.emoji;
        name = `Tap to plant ${sc.name}`;
      }

      el.innerHTML = `
        <div class="badge">${badge}</div>
        <div class="emoji">${emoji}</div>
        <div class="name">${name}</div>
        <div class="bar"><i style="width:${bar.toFixed(1)}%"></i></div>
        <div class="foot"><span>${footL}</span><span>${footR}</span></div>
      `;

      const tap = ()=>{
        if(p.crop){
          if(isReady(p)){
            const earned = harvest(idx);
            addQuestProgress("harv", 1);
            addQuestProgress("earn", earned);
            toast("üß∫ +" + format(earned) + " coins");
          }else{
            toast("‚è≥ Not ready yet");
          }
        }else{
          openCropModal("plantSlot", idx);
        }
        checkAchievements();
        save(); renderAll();
      };

      // Improve WebView tap reliability
      el.addEventListener("click", tap);
      el.addEventListener("touchstart", (e)=>{ e.preventDefault(); tap(); }, {passive:false});

      ui.field.appendChild(el);
    });

    // Boost label
    const { boostPrice } = calcPrices();
    if(now() < state.boostUntil){
      const left = Math.max(0, state.boostUntil - now());
      ui.btnBoost.querySelector(".r").innerHTML = `<b>${(left/1000).toFixed(0)}s</b> left`;
    }else{
      ui.btnBoost.querySelector(".r").innerHTML = `<b>${format(boostPrice)}</b> coins`;
    }
  }

  function renderAll(){
    renderHeader();
    renderFarm();
    calcPrices();
  }

  // Wire buttons with touch + click
  function onTap(el, fn){
    el.addEventListener("click", fn);
    el.addEventListener("touchstart", (e)=>{ e.preventDefault(); fn(); }, {passive:false});
  }

  let state = load();

  function init(){
    applyOfflineIdle();
    checkAchievements();
    save();

    onTap(ui.btnPlantAll, ()=>openCropModal("plantAll"));
    onTap(ui.btnHarvestAll, harvestAll);
    onTap(ui.btnBoost, boost);
    onTap(ui.btnReset, resetAll);

    onTap(ui.btnDaily, claimDaily);
    onTap(ui.btnQuests, tryClaimQuests);
    onTap(ui.btnPrestige, doPrestige);

    onTap(ui.btnSaveTools, ()=>{
      const choice = prompt("Type:\n1 = Export\n2 = Import\n\nEnter 1 or 2:");
      if(choice === "1") exportSave();
      else if(choice === "2") importSave();
    });

    document.querySelectorAll(".buy").forEach(btn=>{
      const type = btn.getAttribute("data-buy");
      onTap(btn, ()=>buy(type));
    });

    onTap(ui.modalClose, closeCropModal);
    ui.modalBack.addEventListener("click", (e)=>{ if(e.target === ui.modalBack) closeCropModal(); });

    renderAll();

    // Auto farmer loop
    setInterval(autoTick, 1400);

    // Lightweight UI refresh (progress bars)
    setInterval(()=>{ renderFarm(); }, 350);
  }

  init();
  </script>
</body>
</html>
